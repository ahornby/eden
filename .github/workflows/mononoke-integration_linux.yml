# This file was @generated by getdeps.py

name: Mononoke Integration Linux

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

permissions:
  contents: read  #  to fetch code (actions/checkout)

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    - name: Update system package info
      run: sudo apt-get update
    - name: Install system deps
      run: sudo python3 build/fbcode_builder/getdeps.py --allow-system-packages install-system-deps --recursive mononoke_integration && sudo python3 build/fbcode_builder/getdeps.py --allow-system-packages install-system-deps --recursive patchelf
    - id: paths
      name: Query paths
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages query-paths --recursive --src-dir=. mononoke_integration  >> "$GITHUB_OUTPUT"
    - name: Install Rust Stable
      uses: dtolnay/rust-toolchain@stable
    - name: Fetch git-lfs
      if: ${{ steps.paths.outputs.git-lfs_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests git-lfs
    - name: Fetch ripgrep
      if: ${{ steps.paths.outputs.ripgrep_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests ripgrep
    - name: Fetch tree
      if: ${{ steps.paths.outputs.tree_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests tree
    - name: Fetch bz2
      if: ${{ steps.paths.outputs.bz2_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests bz2
    - name: Fetch ninja
      if: ${{ steps.paths.outputs.ninja_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests ninja
    - name: Fetch cmake
      if: ${{ steps.paths.outputs.cmake_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests cmake
    - name: Fetch zstd
      if: ${{ steps.paths.outputs.zstd_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests zstd
    - name: Fetch python-click
      if: ${{ steps.paths.outputs.python-click_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python-click
    - name: Fetch sqlite3
      if: ${{ steps.paths.outputs.sqlite3_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests sqlite3
    - name: Fetch gflags
      if: ${{ steps.paths.outputs.gflags_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests gflags
    - name: Fetch glog
      if: ${{ steps.paths.outputs.glog_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests glog
    - name: Fetch fmt
      if: ${{ steps.paths.outputs.fmt_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fmt
    - name: Fetch googletest
      if: ${{ steps.paths.outputs.googletest_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests googletest
    - name: Fetch xxhash
      if: ${{ steps.paths.outputs.xxhash_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests xxhash
    - name: Fetch python-setuptools
      if: ${{ steps.paths.outputs.python-setuptools_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python-setuptools
    - name: Fetch autoconf
      if: ${{ steps.paths.outputs.autoconf_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests autoconf
    - name: Fetch automake
      if: ${{ steps.paths.outputs.automake_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests automake
    - name: Fetch libtool
      if: ${{ steps.paths.outputs.libtool_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libtool
    - name: Fetch jq
      if: ${{ steps.paths.outputs.jq_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests jq
    - name: Fetch libsodium
      if: ${{ steps.paths.outputs.libsodium_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libsodium
    - name: Fetch boost
      if: ${{ steps.paths.outputs.boost_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests boost
    - name: Fetch double-conversion
      if: ${{ steps.paths.outputs.double-conversion_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests double-conversion
    - name: Fetch fast_float
      if: ${{ steps.paths.outputs.fast_float_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fast_float
    - name: Fetch libdwarf
      if: ${{ steps.paths.outputs.libdwarf_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libdwarf
    - name: Fetch libevent
      if: ${{ steps.paths.outputs.libevent_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libevent
    - name: Fetch libunwind
      if: ${{ steps.paths.outputs.libunwind_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libunwind
    - name: Fetch lz4
      if: ${{ steps.paths.outputs.lz4_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests lz4
    - name: Fetch snappy
      if: ${{ steps.paths.outputs.snappy_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests snappy
    - name: Fetch xz
      if: ${{ steps.paths.outputs.xz_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests xz
    - name: Fetch zlib
      if: ${{ steps.paths.outputs.zlib_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests zlib
    - name: Fetch libiberty
      if: ${{ steps.paths.outputs.libiberty_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libiberty
    - name: Fetch folly
      if: ${{ steps.paths.outputs.folly_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests folly
    - name: Fetch libffi
      if: ${{ steps.paths.outputs.libffi_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libffi
    - name: Fetch ncurses
      if: ${{ steps.paths.outputs.ncurses_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests ncurses
    - name: Fetch python
      if: ${{ steps.paths.outputs.python_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python
    - name: Fetch nmap
      if: ${{ steps.paths.outputs.nmap_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests nmap
    - name: Fetch openssl
      if: ${{ steps.paths.outputs.openssl_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests openssl
    - name: Fetch liboqs
      if: ${{ steps.paths.outputs.liboqs_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests liboqs
    - name: Fetch fizz
      if: ${{ steps.paths.outputs.fizz_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fizz
    - name: Fetch mvfst
      if: ${{ steps.paths.outputs.mvfst_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests mvfst
    - name: Fetch wangle
      if: ${{ steps.paths.outputs.wangle_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests wangle
    - name: Fetch fbthrift
      if: ${{ steps.paths.outputs.fbthrift_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fbthrift
    - name: Fetch fb303
      if: ${{ steps.paths.outputs.fb303_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fb303
    - name: Fetch rust-shed
      if: ${{ steps.paths.outputs.rust-shed_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests rust-shed
    - name: Build git-lfs
      if: ${{ steps.paths.outputs.git-lfs_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests git-lfs
    - name: Build ripgrep
      if: ${{ steps.paths.outputs.ripgrep_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests ripgrep
    - name: Build tree
      if: ${{ steps.paths.outputs.tree_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests tree
    - name: Build bz2
      if: ${{ steps.paths.outputs.bz2_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests bz2
    - name: Build ninja
      if: ${{ steps.paths.outputs.ninja_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests ninja
    - name: Build cmake
      if: ${{ steps.paths.outputs.cmake_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests cmake
    - name: Build zstd
      if: ${{ steps.paths.outputs.zstd_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests zstd
    - name: Build python-click
      if: ${{ steps.paths.outputs.python-click_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests python-click
    - name: Build sqlite3
      if: ${{ steps.paths.outputs.sqlite3_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests sqlite3
    - name: Build gflags
      if: ${{ steps.paths.outputs.gflags_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests gflags
    - name: Build glog
      if: ${{ steps.paths.outputs.glog_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests glog
    - name: Build fmt
      if: ${{ steps.paths.outputs.fmt_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fmt
    - name: Build googletest
      if: ${{ steps.paths.outputs.googletest_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests googletest
    - name: Build xxhash
      if: ${{ steps.paths.outputs.xxhash_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests xxhash
    - name: Build python-setuptools
      if: ${{ steps.paths.outputs.python-setuptools_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests python-setuptools
    - name: Build autoconf
      if: ${{ steps.paths.outputs.autoconf_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests autoconf
    - name: Build automake
      if: ${{ steps.paths.outputs.automake_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests automake
    - name: Build libtool
      if: ${{ steps.paths.outputs.libtool_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libtool
    - name: Build jq
      if: ${{ steps.paths.outputs.jq_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests jq
    - name: Build libsodium
      if: ${{ steps.paths.outputs.libsodium_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libsodium
    - name: Build boost
      if: ${{ steps.paths.outputs.boost_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests boost
    - name: Build double-conversion
      if: ${{ steps.paths.outputs.double-conversion_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests double-conversion
    - name: Build fast_float
      if: ${{ steps.paths.outputs.fast_float_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fast_float
    - name: Build libdwarf
      if: ${{ steps.paths.outputs.libdwarf_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libdwarf
    - name: Build libevent
      if: ${{ steps.paths.outputs.libevent_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libevent
    - name: Build libunwind
      if: ${{ steps.paths.outputs.libunwind_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libunwind
    - name: Build lz4
      if: ${{ steps.paths.outputs.lz4_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests lz4
    - name: Build snappy
      if: ${{ steps.paths.outputs.snappy_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests snappy
    - name: Build xz
      if: ${{ steps.paths.outputs.xz_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests xz
    - name: Build zlib
      if: ${{ steps.paths.outputs.zlib_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests zlib
    - name: Build libiberty
      if: ${{ steps.paths.outputs.libiberty_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libiberty
    - name: Build folly
      if: ${{ steps.paths.outputs.folly_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests folly
    - name: Build libffi
      if: ${{ steps.paths.outputs.libffi_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests libffi
    - name: Build ncurses
      if: ${{ steps.paths.outputs.ncurses_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests ncurses
    - name: Build python
      if: ${{ steps.paths.outputs.python_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests python
    - name: Build nmap
      if: ${{ steps.paths.outputs.nmap_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests nmap
    - name: Build openssl
      if: ${{ steps.paths.outputs.openssl_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests openssl
    - name: Build liboqs
      if: ${{ steps.paths.outputs.liboqs_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests liboqs
    - name: Build fizz
      if: ${{ steps.paths.outputs.fizz_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fizz
    - name: Build mvfst
      if: ${{ steps.paths.outputs.mvfst_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests mvfst
    - name: Build wangle
      if: ${{ steps.paths.outputs.wangle_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests wangle
    - name: Build fbthrift
      if: ${{ steps.paths.outputs.fbthrift_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fbthrift
    - name: Build fb303
      if: ${{ steps.paths.outputs.fb303_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests fb303
    - name: Build rust-shed
      if: ${{ steps.paths.outputs.rust-shed_SOURCE }}
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests rust-shed
    - name: Build mononoke
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --src-dir=. --no-tests mononoke
    - name: Build sapling
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --src-dir=. --no-tests sapling
    - name: Build mononoke_integration
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-deps --src-dir=. mononoke_integration  --project-install-prefix mononoke_integration:/usr/local
    - name: Copy artifacts
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fixup-dyn-deps --strip --src-dir=. mononoke_integration _artifacts/linux  --project-install-prefix mononoke_integration:/usr/local --final-install-prefix /usr/local
    - uses: actions/upload-artifact@v4
      with:
        name: mononoke_integration
        path: _artifacts
    - name: Test mononoke_integration
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages test --num-jobs 4 --src-dir=. mononoke_integration  --project-install-prefix mononoke_integration:/usr/local
